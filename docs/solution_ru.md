# Документация к решению

## Введение

В рамках тестового задания реализован механизм записи событий в ClickHouse с использованием шаблона транзакционного outbox.
Решение направлено на устранение проблем, связанных с потерей событий, сетевыми ошибками и высокой нагрузкой на ClickHouse из-за большого количества построчных записей.

## Архитектурное решение

### Основные изменения
1. **Добавлена таблица `event_outbox` в PostgreSQL** для временного хранения событий перед их отправкой в ClickHouse.
2. **Реализована Celery-задача**, которая периодически собирает события из `event_outbox` и отправляет их в ClickHouse пакетами.
3. **Гарантирована транзакционная целостность**: события записываются в `event_outbox` в рамках основной бизнес-логики, что предотвращает их потерю при сбоях.
4. **Использовано структурированное логирование (structlog)** и интеграция с Sentry для мониторинга и отладки.

### Поток обработки событий
1. **Создание событий**: в коде приложения при возникновении события оно сохраняется в `event_outbox` в PostgreSQL.
2. **Фоновая обработка**: Celery периодически извлекает события из `event_outbox`, группирует их в батчи по 1000 и отправляет в ClickHouse.


### Структура `event_outbox`

| Колонка          | Тип данных   | Описание                                      |
|------------------|--------------|-----------------------------------------------|
| id               | BIGSERIAL    | Уникальный идентификатор                      |
| event_type       | VARCHAR(255) | Тип события                                   |
| event_date_time  | TIMESTAMP    | Дата и время события                          |
| environment      | VARCHAR(50)  | Окружение                                     |
| event_context    | JSONB        | Данные события                                |
| metadata_version | BIGINT       | Версия схемы метаданных                       |
| status           | VARCHAR(20)  | Статус обработки (pending, processed, failed) |
| created_at       | TIMESTAMP    | Время создания                                |
| updated_at       | TIMESTAMP    | Время последнего обновления                   |

### Celery-задача для отправки событий в ClickHouse

- Выбирает события со статусом `pending`, `failed`.
- Группирует их в батчи.
- Отправляет в ClickHouse одним SQL-запросом .
- В случае успеха обновляет статус событий на `processed`.
- В случае ошибки статус обновляется на `failed`, а информация о сбое логируется. 

## Настройка и запуск проекта

### 1. Запуск через Docker
```sh
docker-compose up -d --build
```

### 2. Применение миграций
```sh
docker-compose exec app python manage.py migrate
```

### 3. Запуск Celery-воркеров: 
```sh
docker-compose exec app celery -A core.celery worker --loglevel=info
```

### 4. Запуск Celery-beat: 
```sh
docker-compose exec app celery -A core.celery beat --loglevel=info

```

## Логирование и мониторинг
- **Structlog** используется для форматированного логирования.
- Mожно добавить мониторинг события с состоянием failed, настроив уведомления или периодические проверки для событий с этим статусом. Это можно сделать через Sentry или с помощью собственных решений для мониторинга, которые отслеживают статус событий и уведомляют администраторов в случае повторных сбоев или неожиданных проблем.

## Тестирование

### Запуск всех тестов
```sh
	docker compose run --rm app pytest -svv
```

## Вывод
Данное решение решает проблемы потери данных, улучшает производительность ClickHouse и делает обработку логов транзакционно безопасной. Celery обеспечивает надежную фоновую обработку событий, а структурированное логирование помогает в мониторинге работы системы.
Можно также добавить 
